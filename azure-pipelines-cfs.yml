resources:
- repo: self

trigger:
  batch: true
  branches:
    include:
    - '*'

pr:
  branches:
    include:
    - '*'
  paths:
    exclude:
    - azure-pipelines-cfs.yml

variables:
- template: ${{ variables.Pipeline.Workspace }}/.azure-pipelines/templates/variables.yml
- name: Codeql.Enabled
  value: false
- name: PIP_INDEX_URL



jobs:
- job: AddWindowsDependencies
  displayName: Add Windows Dependencies
  pool:
    name: ${{ variables.windows_pool }}
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: 3.11
  - task: PipAuthenticate@1
    displayName: 'Pip Authenticate'
    inputs:
      artifactFeeds: 'public/azure-cli-feed'
  - powershell: |
      Set-PSDebug -Trace 1
      python3 -m venv venv
      pip install --upgrade pip setuptools
      ./venv/Scripts/Activate.ps1
      Select-String -Path 'src/azure-cli/requirements.py3.Darwin.txt' -Pattern 'azure-cli' -NotMatch | ForEach-Object { $_.Line } | Set-Content 'requirements.txt'
      pip install -r requirements.txt

- job: AddUbuntuDependencies
  displayName: Add Ubuntu Dependencies
  pool:
    name: ${{ variables.ubuntu_pool }}
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: 3.11
  - task: PipAuthenticate@1
    displayName: 'Pip Authenticate'
    inputs:
      artifactFeeds: 'public/azure-cli-feed'
  - bash: |
      set -ev
      python3 -m venv venv
      pip install --upgrade pip setuptools
      source ./venv/bin/activate
      cat src/azure-cli/requirements.py3.Darwin.txt | grep -v azure-cli > requirements.txt
      pip install -r requirements.txt

- job: AddMacosDependencies
  displayName: Add macOS Dependencies
  pool:
    vmImage: ${{ variables.macos_pool }}
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: 3.11
  - task: PipAuthenticate@1
    displayName: 'Pip Authenticate'
    inputs:
      artifactFeeds: 'public/azure-cli-feed'
  - bash: |
      set -ev
      python3 -m venv venv
      pip install --upgrade pip setuptools
      source ./venv/bin/activate
      cat src/azure-cli/requirements.py3.Darwin.txt | grep -v azure-cli > requirements.txt
      pip install -r requirements.txt
